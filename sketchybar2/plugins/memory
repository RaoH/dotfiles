#!/usr/bin/env bash

# Get memory info using vm_stat
MEMORY_INFO=$(vm_stat)

# Get total system memory in bytes
TOTAL_MEMORY_BYTES=$(sysctl -n hw.memsize)
TOTAL_GB=$((TOTAL_MEMORY_BYTES / 1024 / 1024 / 1024))

if [[ "$SENDER" == "mouse.entered" ]]; then
    # Parse detailed memory information
    PAGE_SIZE=$(vm_stat | grep "page size" | awk '{print $8}')
    PAGES_FREE=$(echo "$MEMORY_INFO" | grep "Pages free:" | awk '{print $3}' | sed 's/\.//')
    PAGES_ACTIVE=$(echo "$MEMORY_INFO" | grep "Pages active:" | awk '{print $3}' | sed 's/\.//')
    PAGES_INACTIVE=$(echo "$MEMORY_INFO" | grep "Pages inactive:" | awk '{print $3}' | sed 's/\.//')
    PAGES_SPECULATIVE=$(echo "$MEMORY_INFO" | grep "Pages speculative:" | awk '{print $3}' | sed 's/\.//')
    PAGES_WIRED=$(echo "$MEMORY_INFO" | grep "Pages wired down:" | awk '{print $4}' | sed 's/\.//')
    PAGES_COMPRESSED=$(echo "$MEMORY_INFO" | grep "Pages stored in compressor:" | awk '{print $5}' | sed 's/\.//')
    
    # Convert pages to GB using awk for floating point
    FREE_GB=$(echo "$PAGES_FREE $PAGE_SIZE" | awk '{printf "%.1f", $1 * $2 / 1024 / 1024 / 1024}')
    ACTIVE_GB=$(echo "$PAGES_ACTIVE $PAGE_SIZE" | awk '{printf "%.1f", $1 * $2 / 1024 / 1024 / 1024}')
    INACTIVE_GB=$(echo "$PAGES_INACTIVE $PAGE_SIZE" | awk '{printf "%.1f", $1 * $2 / 1024 / 1024 / 1024}')
    WIRED_GB=$(echo "$PAGES_WIRED $PAGE_SIZE" | awk '{printf "%.1f", $1 * $2 / 1024 / 1024 / 1024}')
    COMPRESSED_GB=$(echo "$PAGES_COMPRESSED $PAGE_SIZE" | awk '{printf "%.1f", $1 * $2 / 1024 / 1024 / 1024}')
    
    # Used memory = Active + Wired + Compressed (like Activity Monitor)
    USED_GB=$(echo "$ACTIVE_GB $WIRED_GB $COMPRESSED_GB" | awk '{printf "%.1f", $1 + $2 + $3}')
    # Available = Free + Inactive + Speculative
    AVAILABLE_GB=$(echo "$FREE_GB $INACTIVE_GB" | awk '{printf "%.1f", $1 + $2}')
    
    DETAILED_INFO="${TOTAL_GB}GB | Used:${USED_GB}GB Available:${AVAILABLE_GB}GB Wired:${WIRED_GB}GB"
    
    sketchybar --set "$NAME" label="$DETAILED_INFO"
    
elif [[ "$SENDER" == "mouse.exited" ]]; then
    # Restore normal memory percentage display
    PAGE_SIZE=$(vm_stat | grep "page size" | awk '{print $8}')
    PAGES_ACTIVE=$(echo "$MEMORY_INFO" | grep "Pages active:" | awk '{print $3}' | sed 's/\.//')
    PAGES_WIRED=$(echo "$MEMORY_INFO" | grep "Pages wired down:" | awk '{print $4}' | sed 's/\.//')
    PAGES_COMPRESSED=$(echo "$MEMORY_INFO" | grep "Pages stored in compressor:" | awk '{print $5}' | sed 's/\.//')
    
    # Calculate used memory in bytes (Active + Wired + Compressed)
    USED_BYTES=$(echo "$PAGES_ACTIVE $PAGES_WIRED $PAGES_COMPRESSED $PAGE_SIZE" | awk '{printf "%.0f", ($1 + $2 + $3) * $4}')
    
    # Calculate percentage
    MEMORY_PERCENT=$(echo "$USED_BYTES $TOTAL_MEMORY_BYTES" | awk '{printf "%.0f", $1 * 100 / $2}')
    
    sketchybar --set "$NAME" label="${MEMORY_PERCENT}%"
    
else
    # Normal update (not hover event)
    PAGE_SIZE=$(vm_stat | grep "page size" | awk '{print $8}')
    PAGES_ACTIVE=$(echo "$MEMORY_INFO" | grep "Pages active:" | awk '{print $3}' | sed 's/\.//')
    PAGES_WIRED=$(echo "$MEMORY_INFO" | grep "Pages wired down:" | awk '{print $4}' | sed 's/\.//')
    PAGES_COMPRESSED=$(echo "$MEMORY_INFO" | grep "Pages stored in compressor:" | awk '{print $5}' | sed 's/\.//')
    
    # Calculate used memory in bytes (Active + Wired + Compressed)
    USED_BYTES=$(echo "$PAGES_ACTIVE $PAGES_WIRED $PAGES_COMPRESSED $PAGE_SIZE" | awk '{printf "%.0f", ($1 + $2 + $3) * $4}')
    
    # Calculate percentage
    MEMORY_PERCENT=$(echo "$USED_BYTES $TOTAL_MEMORY_BYTES" | awk '{printf "%.0f", $1 * 100 / $2}')
    
    sketchybar --set "$NAME" label="${MEMORY_PERCENT}%"
fi