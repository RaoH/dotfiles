#!/usr/bin/env bash

CORE_COUNT=$(sysctl -n machdep.cpu.thread_count)

if [[ "$SENDER" == "mouse.entered" ]]; then
    # Get detailed CPU info using top
    CPU_DETAILED=$(top -l 2 -n 0 -F 2>/dev/null | grep "CPU usage:" | tail -n 1)
    
    if [[ -n "$CPU_DETAILED" ]]; then
        # Extract percentages directly from the output
        USER_CPU=$(echo "$CPU_DETAILED" | sed 's/.*: \([0-9.]*\)% user.*/\1/')
        SYS_CPU=$(echo "$CPU_DETAILED" | sed 's/.*user, \([0-9.]*\)% sys.*/\1/')
        IDLE_CPU=$(echo "$CPU_DETAILED" | sed 's/.*sys, \([0-9.]*\)% idle.*/\1/')
        
        DETAILED_INFO="$CORE_COUNT cores | U:${USER_CPU}% S:${SYS_CPU}% I:${IDLE_CPU}%"
    else
        DETAILED_INFO="$CORE_COUNT cores"
    fi
    
    sketchybar --set "$NAME" label="$DETAILED_INFO"
    
elif [[ "$SENDER" == "mouse.exited" ]]; then
    # Restore normal CPU percentage display
    CPU_INFO=$(ps -eo pcpu,user 2>/dev/null)
    if [[ -n "$CPU_INFO" ]]; then
        CPU_SYS=$(echo "$CPU_INFO" | grep -v $(whoami) | sed "s/[^ 0-9\.]//g" | awk "{sum+=\$1} END {print sum/(100.0 * $CORE_COUNT)}")
        CPU_USER=$(echo "$CPU_INFO" | grep $(whoami) | sed "s/[^ 0-9\.]//g" | awk "{sum+=\$1} END {print sum/(100.0 * $CORE_COUNT)}")
        CPU_PERCENT="$(echo "$CPU_SYS $CPU_USER" | awk '{printf "%.0f\n", ($1 + $2)*100}')"
        sketchybar --set "$NAME" label="$CPU_PERCENT%"
    fi
    
else
    # Normal update (not hover event)
    CPU_INFO=$(ps -eo pcpu,user 2>/dev/null)
    if [[ -n "$CPU_INFO" ]]; then
        CPU_SYS=$(echo "$CPU_INFO" | grep -v $(whoami) | sed "s/[^ 0-9\.]//g" | awk "{sum+=\$1} END {print sum/(100.0 * $CORE_COUNT)}")
        CPU_USER=$(echo "$CPU_INFO" | grep $(whoami) | sed "s/[^ 0-9\.]//g" | awk "{sum+=\$1} END {print sum/(100.0 * $CORE_COUNT)}")
        CPU_PERCENT="$(echo "$CPU_SYS $CPU_USER" | awk '{printf "%.0f\n", ($1 + $2)*100}')"
        sketchybar --set "$NAME" label="$CPU_PERCENT%"
    fi
fi
